{% extends 'admin/master.html' %}
{% import 'admin/lib.html' as lib with context %}
{% import 'admin/static.html' as admin_static with context%}
{% import 'admin/model/layout.html' as model_layout with context %}
{% import 'admin/actions.html' as actionlib with context %}
{% import 'admin/model/row_actions.html' as row_actions with context %}

{% block head %}
    {{ super() }}
    {{ lib.form_css() }}
{% endblock %}

{% block body %}
<table class="table table-striped table-hover">
  <thead class="thead-light">
    <tr>
      <th>Actions</th>
      <th>Server</th>
      <th>IP</th>
      <th>CPU</th>
      <th>RAM</th>
      <th>Bandwidth</th>
      <th>Disk</th>
    </tr>
  </thead>
  <tbody>
    {% for server in servers %}
    <tr>
      <td><a class="btn btn-primary btn-sm" href="#">Details</a></td>
      <td>{{ server.name }}</td>
      <td name="ip_address">{{ server.ip_address }}</td>
      <td><div class="progress">
        <div name="cpu_usage"></div>
      </div></td>
      <td><div class="progress">
        <div name="ram_usage"></div>
      </div></td>
      <td><div class="progress">
        <div name="bandwidth_usage"></div>
      </div></td>
      <td><div  class="progress">
        <div name="disk_usage"></div>
      </div></td>
    </tr>
    {% endfor %}
  </tbody>
</table>

{% endblock %}

{% block tail %}
<script>
  $(function(){

    function updateAllServers() {
      $('tbody tr').each(function() {
        var row = $(this);
        var ip = row.find('td[name="ip_address"]').text();
        $.get('/admin/node_usage/' + ip + '/', function(data) {
          row.find('div[name="cpu_usage"]').attr({
            'class': 'progress-bar progress-bar-striped',
            'role': 'progressbar',
            'style': 'width: ' + data.cpu + '%;height: 100%;',
            'aria-valuenow': data.cpu,
            'aria-valuemin': '0',
            'aria-valuemax': '100',
            'text': data.cpu + '%'
          });
          row.find('div[name="ram_usage"]').attr({
            'class': 'progress-bar progress-bar-striped',
            'role': 'progressbar',
            'style': 'width: ' + data.ram + '%',
            'aria-valuenow': data.ram,
            'aria-valuemin': '0',
            'aria-valuemax': '100',
            'text': data.ram + '%'
          });
          row.find('div[name="bandwidth_usage"]').attr({
            'class': 'progress-bar progress-bar-striped',
            'role': 'progressbar',
            'style': 'width: ' + data.bandwidth + '%',
            'aria-valuenow': data.bandwidth,
            'aria-valuemin': '0',
            'aria-valuemax': '100',
            'text': data.bandwidth + '%'
          });
          row.find('div[name="disk_usage"]').attr({
            'class': 'progress-bar progress-bar-striped',
            'role': 'progressbar',
            'style': 'width: ' + data.disk + '%',
            'aria-valuenow': data.disk,
            'aria-valuemin': '0',
            'aria-valuemax': '100',
            'text': data.disk + '%'
          });
        });
      });
    }

    updateAllServers();
    setInterval(updateAllServers, 30 * 1000);
  });
</script>
{% endblock %}
